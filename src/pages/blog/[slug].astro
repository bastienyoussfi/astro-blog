---
import "../../styles/globals.css";
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import ColoredText from '../../components/ColoredText.astro';
import PartnerLink from '../../components/PartnerLink.astro';
import ArticleHeader from '../../components/ArticleHeader.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { Facebook, LinkedIn, Twitter } from '../../components/socials';
import { getReadingTime } from '../../utils/articleUtils';

/**
 * Get static paths for all posts from unified collection
 */
export async function getStaticPaths() {
  const allPosts = await getCollection('posts');

  return allPosts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Get reading time from unified field
const readingTime = post.data.timeEstimate || `${getReadingTime(post.body)} min`;

// Get image if available
const image = post.data.image;

// Define components to pass to the Content component
const components = {
  ColoredText,
  PartnerLink
};

// Get current URL and canonical URL for sharing
const currentUrl = Astro.url.href;

// Set canonical URL based on content type
let canonicalUrl = currentUrl;

const encodedTitle = encodeURIComponent(post.data.title);
const encodedUrl = encodeURIComponent(currentUrl);

// Extract the first image from post content or use default
const defaultImage = '/images/default-og.svg';
const postImage = image || defaultImage;
const postImageAlt = post.data.title ? `${post.data.title} - Bastien Youssfi's Blog` : 'Blog post cover image';

// Author information
const authorName = "Bastien Youssfi";
const authorUrl = "https://bastienyoussfi.dev";

// Article dates for Open Graph
const publishedTime = post.data.date.toISOString();
const modifiedTime = post.data.updatedDate ? post.data.updatedDate.toISOString() : publishedTime;

// Tags for Open Graph
const postTags = post.data.tags || [];

// Section/Category
const postSection = 'Technology';
---

<Layout
  title={post.data.title}
  description={post.data.description || `${post.data.title} - Read more on Bastien Youssfi's Blog`}
  canonicalUrl={canonicalUrl}
  image={postImage}
  imageAlt={postImageAlt}
  type="article"
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  author={authorName}
  tags={postTags}
  section={postSection}>
  <article class="blog-container py-8 md:py-12">
    <div class="max-w-[65ch] mx-auto">
      <!-- Breadcrumbs -->
      <Breadcrumbs title={post.data.title} />
      <!-- Article Header -->
      <ArticleHeader
        title={post.data.title}
        description={post.data.description}
        date={post.data.date}
        readingTime={readingTime}
        image={image}
      />

      <!-- Article Content -->
      <div class="prose dark:prose-invert">
        <Content components={components} />
      </div>
      
      <!-- Social Sharing CTA -->
      <div class="mt-16 pt-8 border-t border-border-primary">
        <div class="text-center">
          <h3 class="text-xl font-medium mb-4">Share this article</h3>
          <div class="flex justify-center space-x-5">
            <Twitter encodedTitle={encodedTitle} encodedUrl={encodedUrl} />
            <LinkedIn encodedUrl={encodedUrl} />
            <Facebook encodedUrl={encodedUrl} />          
          </div>
        </div>
      </div>
    </div>
  </article>
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description || `${post.data.title} - Read more on Bastien Youssfi's Blog`,
    "image": defaultImage,
    "datePublished": post.data.date.toISOString(),
    "dateModified": post.data.date.toISOString(),
    "author": {
      "@type": "Person",
      "name": authorName,
      "url": authorUrl
    },
    "publisher": {
      "@type": "Organization",
      "name": "Bastien Youssfi's Blog",
      "logo": {
        "@type": "ImageObject",
        "url": "https://bastienyoussfi.dev/images/logo.png"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": canonicalUrl
    }
  })}></script>

  <!-- Breadcrumb Structured Data (JSON-LD) -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://bastienyoussfi.dev/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": post.data.title
      }
    ]
  })}></script>
</Layout>

<style>
  /* Add styles to automatically optimize images in content */
  :global(.optimize-images img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.375rem;
    margin: 2rem 0;
    display: block;
    
    /* Add loading="lazy" attribute with CSS */
    content-visibility: auto;
    
    /* Add fade-in effect */
    opacity: 0;
    animation: fadeIn 0.5s ease-in-out forwards;
  }
  
  @keyframes fadeIn {
    to { opacity: 1; }
  }
</style>