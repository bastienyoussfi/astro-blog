---
import "../styles/globals.css";
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getReadingTime } from '../utils/articleUtils';

// Get all posts from unified collection (filter out drafts)
const allPosts = (await getCollection('posts', ({ data }) => !data.draft)).map(post => {
  const url = `/blog/${post.slug}`;

  return {
    ...post,
    url,
    date: post.data.date,
    readingTime: post.data.timeEstimate || `${getReadingTime(post.body)} min`,
  };
});

// Sort by date, newest first
allPosts.sort((a, b) => b.date.getTime() - a.date.getTime());

// Group posts by year
const postsByYear = allPosts.reduce((acc, post) => {
  const year = post.date.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof allPosts>);

// Get years sorted in descending order
const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);

// Format function for dates
function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
---

<Layout
  title="Bastien Youssfi's Blog"
  description="Software engineer sharing insights on development, DevOps, and technology. Explore articles on Docker, operating systems, web development, and more."
  canonicalUrl="https://bastienyoussfi.dev/"
  image="/images/default-og.svg"
  imageAlt="Bastien Youssfi's Blog - Software Engineering and DevOps"
>
  <!-- Structured Data: Blog Collection -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Blog",
    "@id": "https://bastienyoussfi.dev/#blog",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://bastienyoussfi.dev/"
    },
    "name": "Bastien Youssfi's Blog",
    "description": "Software engineer sharing insights on development, DevOps, and technology. Explore articles on Docker, operating systems, web development, and more.",
    "publisher": {
      "@id": "https://bastienyoussfi.dev/#person"
    },
    "blogPost": allPosts.slice(0, 10).map(post => ({
      "@type": "BlogPosting",
      "@id": `https://bastienyoussfi.dev${post.url}`,
      "headline": post.data.title,
      "datePublished": post.date.toISOString(),
      "author": {
        "@id": "https://bastienyoussfi.dev/#person"
      }
    })),
    "inLanguage": "en-US"
  })}></script>

  <div class="py-8 md:py-12">
    <div class="mb-8 max-w-[65ch] mx-auto">
    {years.map(year => (
      <section class="mb-12">
        <h2 class="text-7xl font-bold mb-8">{year}</h2>
        <ul class="space-y-6">
          {postsByYear[year].map(post => (
            <li>
              <a href={post.url} class="block hover:opacity-100 opacity-70 transition-opacity">
                <div class="flex flex-col">
                  <h3 class="text-xl font-medium">{post.data.title}</h3>
                  <div class="text-sm mt-1">
                    {formatDate(post.date)} Â· {post.readingTime}
                  </div>
                </div>
              </a>
            </li>
          ))}
        </ul>
      </section>
    ))}
    </div>
  </div>
</Layout>