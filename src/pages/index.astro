---
import "../styles/globals.css";
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getReadingTime } from '../utils/articleUtils';

// Get all content collections (filter out drafts)
const blogPosts = await getCollection('blog', ({ data }) => !data.draft);
const learnPosts = await getCollection('learn', ({ data }) => !data.draft);
const projects = await getCollection('projects', ({ data }) => !data.draft);

// Merge all posts with type information, appropriate URL, and reading time
const allPosts = [
  ...blogPosts.map(post => ({
    ...post,
    type: 'blog' as const,
    url: `/blog/${post.slug}`,
    date: post.data.date,
    readingTime: post.data.readingTime || `${getReadingTime(post.body)}min`,
  })),
  ...learnPosts.map(post => ({
    ...post,
    type: 'learn' as const,
    url: `/blog/${post.slug}`,
    date: post.data.date,
    readingTime: post.data.estimatedTime || `${getReadingTime(post.body)}min`,
  })),
  ...projects.map(post => ({
    ...post,
    type: 'project' as const,
    url: `/blog/${post.slug}`,
    date: post.data.date,
    readingTime: post.data.duration || `${getReadingTime(post.body)}min`,
  })),
];

// Sort by date, newest first
allPosts.sort((a, b) => b.date.getTime() - a.date.getTime());

// Group posts by year
const postsByYear = allPosts.reduce((acc, post) => {
  const year = post.date.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof allPosts>);

// Get years sorted in descending order
const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);

// Format function for dates
function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
---

<Layout title="Bastien Youssfi's Blog">
  <main class="blog-container py-8 md:py-12">
    <div class="mb-8 max-w-[65ch] mx-auto">
    {years.map(year => (
      <section class="mb-12">
        <h2 class="text-7xl font-bold text-gray-100 mb-8">{year}</h2>
        <ul class="space-y-6">
          {postsByYear[year].map(post => (
            <li>
              <a href={post.url} class="block hover:opacity-100 opacity-70 transition-opacity">
                <div class="flex flex-col">
                  <h3 class="text-xl font-medium">{post.data.title}</h3>
                  <div class="text-sm text-gray-500 mt-1">
                    {formatDate(post.date)} Â· {post.readingTime}
                  </div>
                </div>
              </a>
            </li>
          ))}
        </ul>
      </section>
    ))}
    </div>
  </main>
</Layout>